#include "scene_dungeon.h"
#include <LevelSystem.h>
#include "../arvenhold.h"
#include <SFML/Window/Keyboard.hpp>
#include <iostream>
#include "../components/cmp_sprite.h"
#include "../components/cmp_player_physics.h"
#include <system_resources.h>

using namespace std;
using namespace sf;

static shared_ptr<Entity> player;

View view;

Vector2f startPos;

vector<shared_ptr<Entity>> floors;

vector<Vector2f> pillarPos;

void DungeonScene::Update(const double& dt) 
{
	if (Keyboard::isKeyPressed(Keyboard::Tab)) 
	{
		/*view.setCenter({ Engine::getWindowSize().x * 0.5f, Engine::getWindowSize().y * 0.5f });
		Engine::GetWindow().setView(view);*/
		Engine::ChangeScene(&menuScene);
	}
	else
	{
		player->update(dt);
		Scene::Update(dt);
		view.setCenter(player.get()->getPosition());
		Engine::GetWindow().setView(view);
	}
	
}

void DungeonScene::Load() 
{

	cout << " Scene Dungeon Load" << endl;

	auto t = ls::generateDungeon(10);

	generateDungeonEntities(t);
	player = makeEntity();
	
	player->setPosition(startPos);

	auto s = player->addComponent<SpriteComponent>();
	s->setTexure(Resources::get<Texture>("wizard.png"));
	s->getSprite().setOrigin(Vector2f(16.0f, 16.0f));
	s->getSprite().setScale({ 2, 2 });
	//s->getSprite().setTextureRect(sf::IntRect(Vector2(16, 16), Vector2(32, 32)));

	b2PolygonShape Shape;

	b2Vec2 vertices[4];
	vertices[0].Set(-0.5f,-0.5f);
	vertices[1].Set( 0.0f,-1.0f);
	vertices[2].Set( 0.5f,-0.5f);
	vertices[3].Set( 0.0f, 0.0f);

	Shape.Set(vertices, 4);

	player->addComponent<PlayerPhysicsComponent>(Shape);

	view.reset(FloatRect({ 100, 100 }, { 1920, 1080 }));

	Engine::GetWindow().setView(view);

	setLoaded(true);
}

void DungeonScene::generateDungeonEntities(vector<int> t)
{
	auto text = Resources::get<Texture>("dungeon_tiles.png");

	for (int i = 0; i < 135; i++)
	{
		for (int j = 0; j < 135; j++)
		{
			if (t[i * 135 + j] != -1)
			{
				auto tile = makeEntity();

				tile->setPosition(Vector2f(j * 128, i * 128));

				if (t[i * 135 + j] == 84)
				{
					startPos = Vector2f(j * 128, (i-1) * 128);
				}

				auto s = tile->addComponent<SpriteComponent>();
				s->setTexure(text);
				s->getSprite().setOrigin(Vector2f(32.0f, 32.0f));

				auto xpos = t[i * 135 + j] % 12;
				auto ypos = t[i * 135 + j] / 12;
				s->getSprite().setTextureRect(sf::IntRect(Vector2(xpos * 64, ypos * 64), Vector2(64, 64)));
				s->getSprite().setScale({ 2, 2 });

				if (t[i * 135 + j] != 72 && t[i * 135 + j] != 73 && t[i * 135 + j] != 74 && t[i * 135 + j] != 84 && t[i * 135 + j] != 85 && t[i * 135 + j] != 86)
				{
					b2PolygonShape Shape;

					Shape.Set(_polygons[0], 6);

					tile->addComponent<PhysicsComponent>(false, Shape);
				}
			}
		}
	}
}

void DungeonScene::UnLoad()
{
	player.reset();
	floors.clear();
	Scene::UnLoad();
}

void DungeonScene::Render() {

	//Renderer::queue(&text);
	//ls::Render(Engine::GetWindow());
	//player->Render();
	Scene::Render();
}

b2Vec2 DungeonScene::_polygons[120][6] =
{
	// Row 1
	{{ 0.5f,-2.1f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{ 0.0f,-0.5f},{ 0.0f,-2.1f}}, // 0
	{{-2.1f,-0.5f},{ 0.0f,-1.0f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{-2.1f, 0.0f}}, // 1
	{{-2.1f,-0.5f},{ 0.0f,-0.5f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{-2.1f, 0.0f}}, // 2
	{{-2.1f,-0.5f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 0.0f,-0.5f},{-0.5f, 0.0f},{-2.1f, 0.0f}}, // 3
	{{-0.5f,-0.5f},{ 0.0f,-0.5f},{ 0.5f,-0.5f},{ 0.5f, 0.5f},{ 0.0f, 0.5f},{-0.5f, 0.5f}}, // 4
	{{ 0.5f,-2.1f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{ 0.0f,-0.5f},{ 0.0f,-2.1f}}, // 5
	{{-2.1f,-0.5f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 0.0f,-0.5f},{-0.5f, 0.0f},{-2.1f, 0.0f}}, // 6
	{{-0.5f,-0.5f},{ 0.0f,-0.5f},{ 0.5f,-0.5f},{ 0.5f, 0.5f},{ 0.0f, 0.5f},{-0.5f, 0.5f}}, // 7
	{{ 0.0f, 2.1f},{ 0.0f, 0.0f},{ 0.0f,-2.1f},{ 0.5f,-2.1f},{ 0.5f, 0.0f},{ 0.5f, 2.1f}}, // 8
	{{-0.5f,-0.5f},{ 0.0f,-0.5f},{ 0.5f,-0.5f},{ 0.5f, 0.5f},{ 0.0f, 0.5f},{-0.5f, 0.5f}}, // 9
	{{-0.5f,-0.5f},{ 0.0f,-0.5f},{ 0.5f,-0.5f},{ 0.5f, 0.5f},{ 0.0f, 0.5f},{-0.5f, 0.5f}}, // 10
	{{-0.5f, 2.1f},{-0.5f, 0.0f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 0.0f, 0.0f},{ 0.0f, 2.1f}}, // 11
	// Row 2
	{{ 0.0f, 2.1f},{ 0.0f, 0.0f},{ 0.0f,-2.1f},{ 0.5f,-2.1f},{ 0.5f, 0.0f},{ 0.5f, 2.1f}}, // 12
	{{-2.1f,-0.5f},{ 0.0f,-0.5f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{-2.1f, 0.0f}}, // 13
	{{-2.1f,-0.5f},{ 0.0f,-0.5f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{-2.1f, 0.0f}}, // 14
	{{-0.5f, 2.1f},{-0.5f, 0.0f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 0.0f, 0.0f},{ 0.0f, 2.1f}}, // 15
	{{-2.1f,-0.5f},{-0.5f,-0.5f},{ 0.5f, 0.5f},{ 0.5f, 2.1f},{ 0.0f, 2.1f},{-2.1f, 0.0f}}, // 16
	{{-2.1f,-2.1f},{ 0.5f, 0.5f},{ 0.5f, 2.1f},{ 0.0f, 2.1f},{-0.5f, 0.5f},{-2.1f, 0.0f}}, // 17
	{{-0.5f, 2.1f},{-0.5f, 0.5f},{ 2.1f,-2.1f},{ 2.1f, 0.0f},{ 0.5f, 0.5f},{ 0.5f, 2.1f}}, // 18
	{{-0.5f, 2.1f},{-0.5f, 0.5f},{ 0.5f,-0.5f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.0f, 2.1f}}, // 19
	{{},{},{},{},{},{}}, // 20
	{{-2.1f,-0.5f},{ 0.0f,-0.5f},{ 0.5f,-0.5f},{ 2.1f, 2.1f},{ 0.0f, 2.1f},{-2.1f, 0.0f}}, // 21
	{{},{},{},{},{},{}}, // 22
	{{},{},{},{},{},{}}, // 23
	// Row 3
	{{ 0.0f, 2.1f},{ 0.0f, 0.0f},{ 0.0f,-2.1f},{ 0.5f,-2.1f},{ 0.5f, 0.0f},{ 0.5f, 2.1f}}, // 0
	{{-2.1f,-0.5f},{ 0.0f,-0.5f},{ 0.5f,-0.5f},{ 0.5f, 2.1f},{ 0.0f, 2.1f},{-2.1f, 0.0f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{-0.5f, 2.1f},{-0.5f, 0.0f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 0.0f, 0.0f},{ 0.0f, 2.1f}}, // 0
	{{-2.1f,-0.5f},{-0.5f,-0.5f},{ 2.1f, 2.1f},{ 0.0f, 2.1f},{-0.5f, 0.5f},{-2.1f, 0.0f}}, // 0
	{{-2.1f,-2.1f},{ 0.0f, 0.0f},{ 2.1f, 2.1f},{ 0.0f, 2.1f},{-0.5f, 0.5f},{-2.1f, 0.0f}}, // 0
	{{-2.1f, 2.1f},{ 0.0f, 0.0f},{ 2.1f,-2.1f},{ 2.1f, 0.0f},{ 0.5f, 0.5f},{ 0.5f, 2.1f}}, // 0
	{{-2.1f, 2.1f},{ 0.5f,-0.5f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.5f, 0.5f},{ 0.5f, 2.1f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	// Row 4
	{{-2.1f, 0.5f},{-2.1f, 0.0f},{-0.5f,-0.5f},{ 0.0f,-2.1f},{ 0.5f,-2.1f},{ 0.5f, 0.5f}}, // 0
	{{-2.1f,-0.5f},{ 0.0f,-1.0f},{ 0.5f,-0.5f},{ 0.5f, 2.1f},{ 0.0f, 2.1f},{-2.1f, 0.0f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 0.5f},{-0.5f, 0.5f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 2.1f, 0.0f}}, // 0
	{{ 2.1f,-2.1f},{-0.5f, 0.5f},{-2.1f, 0.5f},{-2.1f, 0.0f},{-0.5f,-0.5f},{ 0.0f,-2.1f}}, // 0
	{{ 2.1f,-2.1f},{ 0.0f, 0.0f},{-2.1f, 2.1f},{-2.1f, 0.0f},{-0.5f,-0.5f},{ 0.0f,-2.1f}}, // 0
	{{ 2.1f, 2.1f},{ 0.0f, 0.0f},{-2.1f,-2.1f},{ 0.0f,-2.1f},{ 0.5f,-0.5f},{ 2.1f, 0.0f}}, // 0
	{{ 2.1f, 0.5f},{ 0.5f, 0.5f},{-2.1f,-2.1f},{ 0.0f,-2.1f},{ 0.5f,-0.5f},{ 2.1f, 0.0f}}, // 0
	{{-2.1f, 2.1f},{-2.1f, 0.0f},{-0.5f,-0.5f},{ 0.0f,-2.1f},{ 0.5f,-2.1f},{ 0.5f, 0.5f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	// Row 5
	{{-2.1f, 0.5f},{-2.1f, 0.0f},{-0.5f,-0.5f},{ 0.0f,-2.1f},{ 0.5f,-2.1f},{ 0.5f, 0.5f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 0.5f},{-0.5f, 0.5f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 2.1f, 0.0f}}, // 0
	{{ 0.5f,-2.1f},{ 0.5f,-0.5f},{-0.5f, 0.5f},{-2.1f, 0.5f},{-2.1f, 0.0f},{ 0.0f,-2.1f}}, // 0
	{{ 0.5f,-2.1f},{ 0.5f,-0.5f},{-2.1f, 2.1f},{-2.1f, 0.0f},{-0.5f,-0.5f},{ 0.0f,-2.1f}}, // 0
	{{ 2.1f, 2.1f},{-0.5f,-0.5f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 0.5f,-0.5f},{ 2.1f, 0.0f}}, // 0
	{{ 2.1f, 0.5f},{ 0.5f, 0.5f},{-0.5f,-0.5f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 2.1f, 0.0f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{-2.1f,-0.5f},{ 0.0f,-1.0f},{ 0.5f,-0.5f},{ 2.1f, 2.1f},{ 0.0f, 2.1f},{-2.1f, 0.0f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	// Row 6
	{{},{},{},{},{},{}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 1.0f},{-2.1f, 0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{-2.1f, 0.0f}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 0.5f},{-2.1f, 0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{-2.1f, 0.0f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{ 0.5f,-2.1f},{ 0.5f,-0.5f},{-0.5f, 0.5f},{-2.1f, 0.5f},{-2.1f, 0.0f},{ 0.0f,-2.1f}}, // 0
	{{ 0.5f,-2.1f},{ 0.5f,-0.5f},{-2.1f, 2.1f},{-2.1f, 0.0f},{-0.5f,-0.5f},{ 0.0f,-2.1f}}, // 0
	{{ 2.1f, 2.1f},{-0.5f,-0.5f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 0.5f,-0.5f},{ 2.1f, 0.0f}}, // 0
	{{ 2.1f, 0.5f},{ 0.5f, 0.5f},{-0.5f,-0.5f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 2.1f, 0.0f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	// Row 7
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{-2.1f,-0.5f},{ 0.0f,-0.5f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{-2.1f, 0.0f}}, // 0
	{{-0.5f,-0.5f},{ 0.0f,-0.5f},{ 0.5f,-0.5f},{ 0.5f, 0.5f},{ 0.0f, 0.5f},{-0.5f, 0.5f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{-0.5f,-0.5f},{ 0.0f,-0.5f},{ 0.5f,-0.5f},{ 0.5f, 0.5f},{ 0.0f, 0.5f},{-0.5f, 0.5f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	// Row 8
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 0.5f},{-2.1f, 0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{-2.1f, 0.0f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 1.0f},{-0.5f, 0.5f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 2.1f, 0.0f}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 1.0f},{-0.5f, 0.5f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 2.1f, 0.0f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	// Row 9
	{{-2.1f,-0.5f},{ 0.0f,-1.0f},{ 0.5f,-0.5f},{ 0.5f, 0.5f},{ 0.0f, 1.0f},{-2.1f, 0.5f}}, // 0
	{{-2.1f,-0.5f},{ 0.0f,-0.5f},{ 0.5f,-0.5f},{ 0.5f, 0.5f},{ 0.0f, 1.0f},{-2.1f, 0.5f}}, // 0
	{{-2.1f,-0.5f},{ 0.0f,-1.0f},{ 0.5f,-0.5f},{ 0.5f, 0.5f},{ 0.0f, 0.5f},{-2.1f, 0.5f}}, // 0
	{{-2.1f,-0.5f},{ 0.0f,-0.5f},{ 0.5f,-0.5f},{ 0.5f, 0.5f},{ 0.0f, 0.5f},{-2.1f, 0.5f}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 1.0f},{-0.5f, 0.5f},{-0.5f,-0.5f},{ 0.0f,-1.0f},{ 2.1f,-0.5f}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 1.0f},{-0.5f, 0.5f},{-0.5f,-0.5f},{ 0.0f,-0.5f},{ 2.1f,-0.5f}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 0.5f},{-0.5f, 0.5f},{-0.5f,-0.5f},{ 0.0f,-1.0f},{ 2.1f,-0.5f}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 0.5f},{-0.5f, 0.5f},{-0.5f,-0.5f},{ 0.0f,-0.5f},{ 2.1f,-0.5f}}, // 0
	{{-2.1f,-0.5f},{ 0.0f,-0.5f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{-2.1f, 0.0f}}, // 0
	{{-2.1f,-0.5f},{-0.5f,-2.1f},{ 0.0f,-2.1f},{ 0.0f,-0.5f},{-0.5f, 0.0f},{-2.1f, 0.0f}}, // 0
	{{ 0.5f,-2.1f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{ 0.0f,-0.5f},{ 0.0f,-2.1f}}, // 0
	{{ 2.1f, 0.5f},{ 0.0f, 0.5f},{-2.1f, 0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{-2.1f, 0.0f}}, // 0
	// Row 10
	{{-2.1f,-0.5f},{ 0.0f,-1.0f},{ 2.1f,-0.5f},{ 2.1f, 0.0f},{ 0.0f, 0.0f},{-2.1f, 0.0f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{-0.5f, 0.5f},{-0.5f, 0.0f},{-0.5f,-2.1f},{ 0.5f,-2.1f},{ 0.5f, 0.0f},{ 0.5f, 0.5f}}, // 0
	{{-0.5f, 0.5f},{-0.5f, 0.0f},{-0.5f,-2.1f},{ 0.5f,-2.1f},{ 0.5f, 0.0f},{ 0.5f, 0.5f}}, // 0
	{{-0.5f, 0.5f},{-0.5f, 0.0f},{-0.5f,-2.1f},{ 0.5f,-2.1f},{ 0.5f, 0.0f},{ 0.5f, 0.5f}}, // 0
	{{-0.5f, 0.5f},{-0.5f, 0.0f},{-0.5f,-2.1f},{ 0.5f,-2.1f},{ 0.5f, 0.0f},{ 0.5f, 0.5f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{-2.1f,-0.5f},{ 0.0f,-0.5f},{ 0.5f,-0.5f},{ 0.5f, 2.1f},{ 0.0f, 2.1f},{-2.1f, 0.0f}}, // 0
	{{-2.1f,-0.5f},{ 0.0f,-1.0f},{ 0.5f,-0.5f},{ 0.5f, 2.1f},{ 0.0f, 2.1f},{-2.1f, 0.0f}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}, // 0
	{{},{},{},{},{},{}}  // 0
};
